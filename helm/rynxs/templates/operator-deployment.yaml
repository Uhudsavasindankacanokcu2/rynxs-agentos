apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "rynxs.fullname" . }}-operator
  namespace: {{ .Values.namespace.name }}
  labels:
    {{- include "rynxs.operator.labels" . | nindent 4 }}
    app: rynxs-operator
spec:
  replicas: {{ .Values.operator.replicaCount }}
  selector:
    matchLabels:
      app: rynxs-operator
      {{- include "rynxs.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      labels:
        app: rynxs-operator
        {{- include "rynxs.selectorLabels" . | nindent 8 }}
    spec:
      securityContext:
        {{- toYaml .Values.securityContext | nindent 8 }}
      serviceAccountName: {{ .Values.operator.serviceAccount.name }}
      containers:
        - name: operator
          image: "{{ .Values.operator.image.repository }}:{{ .Values.operator.image.tag }}"
          imagePullPolicy: {{ .Values.operator.image.pullPolicy }}
          env:
            - name: WATCH_NAMESPACE
              value: {{ .Values.namespace.name }}
            - name: EVENT_STORE_PATH
              value: {{ .Values.operator.eventStore.path | quote }}
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            {{- if .Values.operator.writerId }}
            - name: RYNXS_WRITER_ID
              value: {{ .Values.operator.writerId | quote }}
            {{- else }}
            - name: RYNXS_WRITER_ID
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            {{- end }}
            - name: RYNXS_LEADER_ELECTION_ENABLED
              value: {{ ternary "1" "0" .Values.operator.leaderElection.enabled | quote }}
            - name: RYNXS_LEASE_NAME
              value: {{ default (printf "%s-leader" (include "rynxs.fullname" .)) .Values.operator.leaderElection.leaseName | quote }}
            - name: RYNXS_LEASE_DURATION_SECONDS
              value: {{ .Values.operator.leaderElection.leaseDurationSeconds | quote }}
            - name: RYNXS_RENEW_DEADLINE_SECONDS
              value: {{ .Values.operator.leaderElection.renewDeadlineSeconds | quote }}
            - name: RYNXS_RETRY_PERIOD_SECONDS
              value: {{ .Values.operator.leaderElection.retryPeriodSeconds | quote }}
            {{- if .Values.operator.eventStore.rotation.enabled }}
            - name: EVENT_STORE_MAX_BYTES
              value: {{ .Values.operator.eventStore.rotation.maxBytes | quote }}
            - name: EVENT_STORE_MAX_SEGMENTS
              value: {{ .Values.operator.eventStore.rotation.maxSegments | quote }}
            {{- end }}
          resources:
            {{- toYaml .Values.operator.resources | nindent 12 }}
          livenessProbe:
            httpGet:
              path: /healthz
              port: 8080
            initialDelaySeconds: 15
            periodSeconds: 20
          readinessProbe:
            httpGet:
              path: /readyz
              port: 8080
            initialDelaySeconds: 5
            periodSeconds: 10
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - ALL
          volumeMounts:
            - name: eventstore
              mountPath: {{ .Values.operator.eventStore.mountPath | quote }}
      volumes:
        - name: eventstore
          {{- if .Values.operator.eventStore.persistence.enabled }}
          persistentVolumeClaim:
            claimName: {{ include "rynxs.fullname" . }}-operator-eventstore
          {{- else }}
          emptyDir: {}
          {{- end }}
